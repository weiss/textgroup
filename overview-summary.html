<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Textgroup Documentation</title>
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="EDoc">
</head>
<body bgcolor="white">
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<h1>Textgroup Documentation</h1>
<p>Copyright Â© 2022 Holger Weiss</p>
<p><b>Version:</b> 0.1.0 (Apr 1 2022)</p>
<p><b>Authors:</b> Holger Weiss.</p>
<p>Textgroup is a groupchat service usable with TCP clients such as Telnet or
Netcat. Test suite logs can be viewed on
<a href="https://weiss.github.io/textgroup/logs/" target="_top"><tt>https://weiss.github.io/textgroup/logs/</tt></a>, coverage analysis on
<a href="https://weiss.github.io/textgroup/cover/" target="_top"><tt>https://weiss.github.io/textgroup/cover/</tt></a>.</p>

<h3><a name="Building_Textgroup">Building Textgroup</a></h3>

<p>The Textgroup source code can be retrieved and built using the following
commands. This requires <a href="https://erlang.org" target="_top"><tt>https://erlang.org</tt></a> and <a href="https://rebar3.org" target="_top"><tt>https://rebar3.org</tt></a> to be in
the <code>$PATH</code>.</p>

<pre>$ curl -L https://github.com/weiss/textgroup/archive/main.tar.gz | tar -C /tmp -xzf -
$ cd /tmp/textgroup-main
$ rebar3 as prod tar</pre>

<h3><a name="Deploying_Textgroup">Deploying Textgroup</a></h3>

<p>The self-contained release archive built in the previous step can be extracted
to an arbitraty location. It has no runtime dependencies. For a persistent
installation, the administrator might want to create a dedicated <code>_textgroup</code>
user and extract the release archive into that user's <code>$HOME</code> directory:</p>

<pre>$ sudo useradd -r -m -d /opt/textgroup _textgroup
$ sudo tar -C /opt/textgroup -xzf /tmp/textgroup-main/_build/prod/rel/textgroup/textgroup-0.1.0.tar.gz
$ sudo chown -R -h _textgroup:_textgroup /opt/textgroup</pre>

<p>A systemd unit such as the following could be used:</p>

<pre># /etc/systemd/system/textgroup.service

[Unit]
Description=Textgroup server
Wants=epmd.service
After=epmd.service network.target
Documentation=https://weiss.github.io/textgroup/

[Service]
Type=notify
User=_textgroup
ExecStart=/opt/textgroup/bin/textgroup foreground
ExecStop=/opt/textgroup/bin/textgroup stop
Restart=on-failure
WatchdogSec=30
ProtectSystem=full
NoNewPrivileges=true
Environment="ERL_EPMD_ADDRESS=127.0.0.1"

[Install]
WantedBy=multi-user.target</pre>

<p>The service would then be enabled like this:</p>

<pre>sudo systemctl daemon-reload
sudo systemctl --now enable textgroup</pre>

<h3><a name="Configuring_Textgroup">Configuring Textgroup</a></h3>

<p>The <code>/opt/textgroup/releases/0.1.0/sys.config</code> file may be edited in order to
adjust configuration settings such as the TCP port number. As an alternative,
those settings can be overridden on the command line in the systemd unit, e.g.:</p>

<pre>ExecStart=/opt/textgroup/bin/textgroup foreground -textgroup port 1111</pre>

<h3><a name="Controlling_Textgroup">Controlling Textgroup</a></h3>

<p>The Textgroup service can be controlled using the <code>textgroup</code> command. The
caller must have the same <code>.erlang.cookie</code> file (with correct permissions) in
their <code>$HOME</code> directory as the user running Textgroup. For a list of available
commands, see:</p>

<pre>$ /opt/textgroup/bin/textgroup help</pre>

<h3><a name="Using_Textgroup">Using Textgroup</a></h3>

<p>Textgroup can be used with TCP clients such as Telnet or Netcat. For example:</p>

<pre>$ telnet localhost 1111</pre>

<p>Once connected, the server will understand the following commands:</p>

<h4><a name="peers">peers</a></h4>

<p>Show the IP addresses of your current peers.</p>

<h4><a name="stats">stats</a></h4>

<p>Show some statistic regarding the current session.</p>

<h4><a name="help">help</a></h4>

<p>Show a help message.</p>

<h4><a name="quit">quit</a></h4>

<p>Quit the current session.</p>

<p>Any other messages are sent to all connected peers.</p>

<h3><a name="Advanced:_Upgrading_Textgroup">Advanced: Upgrading Textgroup</a></h3>

<p>To create a new release that can be used to hot-upgrade the old one:</p>

<pre>$ cd /tmp/textgroup-main
$ rebar3 as prod release
$ editor src/*.erl
$ sed -i s/0.1.0/0.2.0/ rebar.config src/textgroup.app.src
$ rebar3 as prod release
$ rebar3 as prod appup generate
$ rebar3 as prod relup -n textgroup -v 0.2.0
$ rebar3 as prod tar</pre>

<p>The new release archive must then be copied into place (run this command and the
following ones as the <code>_textgroup</code> user):</p>

<pre>$ cp /tmp/textgroup-main/_build/prod/rel/textgroup/textgroup-0.2.0.tar.gz /opt/textgroup/releases</pre>

<p>Finally, the actual upgrade of the running service is performed like this:</p>

<pre>$ /opt/textgroup/bin/textgroup upgrade 0.2.0</pre>

<p>If the new release doesn't work as expected, a downgrade to the old one can be
performed:</p>

<pre>$ /opt/textgroup/bin/textgroup downgrade 0.2.0</pre>

<p>The unused release can then be removed. E.g., to uninstall the new one after
downgrading:</p>

<pre>$ /opt/textgroup/bin/textgroup uninstall 0.2.0</pre>

A few caveats: If data structures (such as the <code>client_state</code> record) were
modified, converting them during the upgrade requires additional handling, see
the documentation on <a href="https://github.com/lrascao/rebar3_appup_plugin" target="_top"><tt>https://github.com/lrascao/rebar3_appup_plugin</tt></a>. Complex
applications/dependencies may well need explicit support for hot release
upgrades, such as custom <code>appup</code> files. Also, if a different Erlang/OTP version
is used to build a new release, the upgrade process involves a restart of the
emulator. For this to work, the <code>heart</code> functionality must be enabled:
<a href="https://erlang.org/doc/man/heart.html" target="_top"><tt>https://erlang.org/doc/man/heart.html</tt></a>.

<hr>
<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
